<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. House Slot Machine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0033 0%, #4d0066 100%);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .cabinet {
            background: linear-gradient(180deg, #2a0a4d 0%, #1a0533 100%);
            border: 8px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3), inset 0 0 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .title {
            text-align: center;
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700, 0 0 40px #ff6600;
            margin-bottom: 20px;
            letter-spacing: 4px;
            cursor: pointer;
        }

        .counters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .counter {
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .counter-label {
            font-size: 0.9em;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .counter-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #fff;
        }

        .counter-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .counter-btn {
            background: #4d0066;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 1.2em;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .counter-btn:hover {
            background: #6600cc;
            transform: scale(1.1);
        }

        .modifiers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .modifier {
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .modifier.active {
            border-color: #ff0066;
            box-shadow: 0 0 20px #ff0066;
        }

        .modifier-label {
            font-size: 0.8em;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .modifier-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
        }

        .reels-container {
            background: rgba(0, 0, 0, 0.8);
            border: 5px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .reel {
            width: 100px;
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid #ffd700;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .reel-strip {
            position: absolute;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .reel-face {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
        }

        .reel.spinning .reel-strip {
            animation: spin 0.1s linear infinite;
        }

        .reel.ignored {
            border-color: #666;
            opacity: 0.4;
        }

        .reel.winner {
            border-color: #8c00ff;
            box-shadow: 0 0 30px #8c00ff;
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes spin {
            from { transform: translateY(0); }
            to { transform: translateY(-1200px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .result-banner {
            text-align: center;
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-banner.MISS { color: #666; }
        .result-banner.HIT { color: #00ff88; text-shadow: 0 0 20px #00ff88; }
        .result-banner.JACKPOT { 
            color: #ffd700; 
            text-shadow: 0 0 30px #8c00ff, 0 0 60px #ffd700;
            animation: jackpot-flash 0.3s ease-in-out 3;
        }

        @keyframes jackpot-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .payout-tray {
            background: rgba(0, 0, 0, 0.8);
            border: 4px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 150px;
            position: relative;
        }

        .payout-item {
            display: inline-block;
            font-size: 3em;
            margin: 10px;
            animation: token-drop 0.5s ease-out;
        }

        @keyframes token-drop {
            0% { transform: translateY(-100px) scale(0); opacity: 0; }
            60% { transform: translateY(10px) scale(1.2); }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        .lifegain-float {
            position: absolute;
            font-size: 3em;
            color: #00ff88;
            font-weight: bold;
            animation: float-up 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .treasure-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .treasure-input label {
            color: #ffd700;
            font-size: 1.2em;
        }

        .treasure-input input {
            width: 80px;
            padding: 10px;
            font-size: 1.5em;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #ffd700;
            color: #fff;
            border-radius: 5px;
            text-align: center;
        }

        .spin-button {
            flex: 1;
            min-width: 200px;
            padding: 30px;
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(180deg, #8c00ff 0%, #cc0044 100%);
            border: 5px solid #ffd700;
            border-radius: 15px;
            color: #ffd700;
            cursor: pointer;
            text-shadow: 0 0 10px #000;
            box-shadow: 0 10px 30px rgba(255, 0, 102, 0.5);
            transition: all 0.2s;
        }

        .spin-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 0, 102, 0.8);
        }

        .spin-button:active {
            transform: translateY(0);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 25px;
            font-size: 1.2em;
            background: #4d0066;
            border: 3px solid #ffd700;
            color: #ffd700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #6600cc;
            transform: scale(1.05);
        }

        .event-log {
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #ffd700;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .event-log h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ffd700;
            font-size: 0.9em;
        }

        .log-entry.JACKPOT {
            border-left-color: #8c00ff;
            background: rgba(255, 0, 102, 0.1);
        }

        .shake {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="container">
        <div class="cabinet">
            <h1 class="title" onclick="toggleFullscreen()">ðŸŽ° MR. HOUSE ðŸŽ°</h1>
            
            <div class="counters">
                <div class="counter">
                    <div class="counter-label">LIFE</div>
                    <div class="counter-value" id="life">40</div>
                    <div class="counter-controls">
                        <button class="counter-btn" data-field="life" data-delta="-1">-</button>
                        <button class="counter-btn" data-field="life" data-delta="1">+</button>
                    </div>
                </div>
                <div class="counter">
                    <div class="counter-label">ROBOTS</div>
                    <div class="counter-value" id="robots">0</div>
                    <div class="counter-controls">
                        <button class="counter-btn" data-field="robots" data-delta="-1">-</button>
                        <button class="counter-btn" data-field="robots" data-delta="1">+</button>
                    </div>
                </div>
                <div class="counter">
                    <div class="counter-label">TREASURES</div>
                    <div class="counter-value" id="treasures">0</div>
                    <div class="counter-controls">
                        <button class="counter-btn" data-field="treasures" data-delta="-1">-</button>
                        <button class="counter-btn" data-field="treasures" data-delta="1">+</button>
                    </div>
                </div>
            </div>

            <div class="modifiers">
                <div class="modifier" id="mod-barbarian">
                    <div class="modifier-label">BARBARIAN CLASS</div>
                    <div class="modifier-value" onclick="toggleBarbarian()">OFF</div>
                </div>
                <div class="modifier">
                    <div class="modifier-label">TOKEN MULT</div>
                    <div class="modifier-value">
                        <button class="counter-btn" data-field="token_multiplier" data-delta="-1">-</button>
                        <span id="token-mult">0</span>
                        <button class="counter-btn" data-field="token_multiplier" data-delta="1">+</button>
                    </div>
                </div>
                <div class="modifier">
                    <div class="modifier-label">LIFEGAIN MULT</div>
                    <div class="modifier-value">
                        <button class="counter-btn" data-field="lifegain_multiplier" data-delta="-1">-</button>
                        <span id="lifegain-mult">0</span>
                        <button class="counter-btn" data-field="lifegain_multiplier" data-delta="1">+</button>
                    </div>
                </div>
                <div class="modifier">
                    <div class="modifier-label">ETB SOURCES</div>
                    <div class="modifier-value">
                        <button class="counter-btn" data-field="etb_lifegain_sources" data-delta="-1">-</button>
                        <span id="etb-sources">0</span>
                        <button class="counter-btn" data-field="etb_lifegain_sources" data-delta="1">+</button>
                    </div>
                </div>
            </div>

            <div class="reels-container" id="reels"></div>

            <div class="result-banner" id="result"></div>

            <div class="payout-tray" id="payout"></div>

            <div class="controls">
                <div class="treasure-input">
                    <label>SPEND TREASURES:</label>
                    <input
                            type="number"
                            id="treasure-spend"
                            value="0"
                            min="0"
                            max="4"
                            step="1"
                        />
                </div>
                <button class="spin-button" id="spin-btn" onclick="spin()">PULL LEVER</button>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="undo()">UNDO</button>
                <button class="action-btn" onclick="save()">SAVE</button>
                <button class="action-btn" onclick="load()">LOAD</button>
                <button class="action-btn" onclick="reset()">RESET</button>
            </div>

            <div class="event-log">
                <h3>EVENT LOG</h3>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <script>
        const MAX_TREASURE_SPEND = 4;
        const STORAGE_KEY = 'mr_house_save';

        // Default state
        const defaultState = {
            life: 40,
            robots: 0,
            treasures: 0,
            token_multiplier: 0,
            lifegain_multiplier: 0,
            etb_lifegain_sources: 0,
            barbarian_class_active: false,
            jackpot_count: 0,
            event_log: []
        };

        let state = { ...defaultState };
        let isSpinning = false;

        // Load sound effects
        const pullSound = new Audio('PULL.wav');
        const nextSound = new Audio('NEXT.wav');
        const missSound = new Audio('MISS.wav');
        const hitSound = new Audio('HIT.wav');
        const jackpotSound = new Audio('JACKPOT.wav');

        function playSound(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        function toggleFullscreen() {
            const doc = document.documentElement;

            if (
                !document.fullscreenElement &&
                !document.mozFullScreenElement &&
                !document.webkitFullscreenElement &&
                !document.msFullscreenElement
            ) {
                if (doc.requestFullscreen) {
                    doc.requestFullscreen();
                } else if (doc.mozRequestFullScreen) {
                    doc.mozRequestFullScreen();
                } else if (doc.webkitRequestFullscreen) {
                    doc.webkitRequestFullscreen();
                } else if (doc.msRequestFullscreen) {
                    doc.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        function updateUI() {
            document.getElementById('life').textContent = formatNumber(state.life);
            document.getElementById('robots').textContent = formatNumber(state.robots);
            document.getElementById('treasures').textContent = formatNumber(state.treasures);
            document.getElementById('token-mult').textContent = state.token_multiplier;
            document.getElementById('lifegain-mult').textContent = state.lifegain_multiplier;
            document.getElementById('etb-sources').textContent = state.etb_lifegain_sources;
            
            const barbarianMod = document.getElementById('mod-barbarian');
            const barbarianValue = barbarianMod.querySelector('.modifier-value');
            barbarianValue.textContent = state.barbarian_class_active ? 'ON' : 'OFF';
            barbarianMod.classList.toggle('active', state.barbarian_class_active);
            
            updateLog();
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        // Client-side spin logic (replaces /api/spin)
        function performSpin(treasures_spent) {
            const numDice = 1 + treasures_spent;
            let diceRolls, ignoredRolls = [];

            // Roll dice
            if (state.barbarian_class_active) {
                const totalRolled = numDice * 2;
                let rolls = [];
                for (let i = 0; i < totalRolled; i++) {
                    rolls.push(Math.floor(Math.random() * 6) + 1);
                }
                rolls.sort((a, b) => a - b);
                ignoredRolls = rolls.slice(0, numDice);
                diceRolls = rolls.slice(numDice);
            } else {
                diceRolls = [];
                for (let i = 0; i < numDice; i++) {
                    diceRolls.push(Math.floor(Math.random() * 6) + 1);
                }
            }

            // Evaluate rolls
            let baseRobots = 0;
            let baseTreasures = 0;
            let hitCount = 0;
            let jackpotCount = 0;
            let missCount = 0;

            for (const die of diceRolls) {
                if (die <= 3) {
                    missCount++;
                } else if (die <= 5) {
                    hitCount++;
                    baseRobots++;
                } else {
                    jackpotCount++;
                    baseRobots++;
                    baseTreasures++;
                }
            }

            // Outcome
            let outcome;
            if (jackpotCount > 0) {
                outcome = 'JACKPOT';
                state.jackpot_count += jackpotCount;
            } else if (hitCount > 0) {
                outcome = 'HIT';
            } else {
                outcome = 'MISS';
            }

            // Token multiplier (2^mult)
            const tokenMult = Math.pow(2, state.token_multiplier);
            const robotsCreated = baseRobots * tokenMult;
            const treasuresCreated = baseTreasures * tokenMult;

            // Lifegain logic
            let lifeGained = 0;
            if (state.etb_lifegain_sources > 0) {
                const baseLife = robotsCreated * state.etb_lifegain_sources;
                const lifeMult = Math.pow(2, state.lifegain_multiplier);
                lifeGained = baseLife * lifeMult;
            }

            // Apply rewards
            state.robots += robotsCreated;
            state.treasures += treasuresCreated;
            state.life += lifeGained;

            // Create event
            const event = {
                timestamp: new Date().toISOString(),
                treasures_spent: treasures_spent,
                dice_rolls: diceRolls,
                ignored_rolls: ignoredRolls,
                outcome: outcome,
                miss_count: missCount,
                hit_count: hitCount,
                jackpot_count: jackpotCount,
                robots_created: robotsCreated,
                treasures_created: treasuresCreated,
                life_gained: lifeGained
            };

            state.event_log.push(event);

            return event;
        }

        async function spin() {
            if (isSpinning) return;

            let treasureSpend = parseInt(document.getElementById('treasure-spend').value) || 0;
            treasureSpend = Math.min(treasureSpend, MAX_TREASURE_SPEND);

            if (treasureSpend > state.treasures) {
                alert('Not enough treasures!');
                return;
            }

            playSound(pullSound);

            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            document.getElementById('result').textContent = '';
            document.getElementById('payout').innerHTML = '';

            // Deduct treasures immediately
            state.treasures -= treasureSpend;
            updateUI();

            // Perform spin (client-side)
            const event = performSpin(treasureSpend);

            // Animate
            await animateSpin(event);

            // Update UI with results
            updateUI();

            document.getElementById('spin-btn').disabled = false;
            isSpinning = false;
        }

        async function animateSpin(event) {
            const reelsContainer = document.getElementById('reels');
            reelsContainer.innerHTML = '';
            reelsContainer.classList.add('shake');

            const reels = [];
            const finalCount = event.dice_rolls.length;

            function createReel() {
                const reel = document.createElement('div');
                reel.className = 'reel';

                const strip = document.createElement('div');
                strip.className = 'reel-strip';

                for (let i = 1; i <= 6; i++) {
                    const face = document.createElement('div');
                    face.className = 'reel-face';
                    face.textContent = i;
                    strip.appendChild(face);
                }

                reel.appendChild(strip);
                reelsContainer.appendChild(reel);
                return { element: reel, strip };
            }

            // Build ONLY the final number of reels
            for (let i = 0; i < finalCount; i++) {
                reels.push(createReel());
            }

            // Initial spin
            reels.forEach(r => r.element.classList.add('spinning'));
            await sleep(800);

            const hasBarbarian = event.ignored_rolls && event.ignored_rolls.length > 0;

            // Phase 1: show WORSE rolls
            if (hasBarbarian) {
                for (let i = 0; i < reels.length; i++) {
                    const reel = reels[i];
                    const badValue = event.ignored_rolls[i];

                    reel.element.classList.remove('spinning');
                    reel.strip.style.transform = `translateY(${-(badValue - 1) * 200}px)`;
                    reel.element.classList.add('ignored');

                    reelsContainer.classList.add('shake');
                    await sleep(100);
                    reelsContainer.classList.remove('shake');
                    await sleep(150);
                }

                await sleep(300);

                // Pull lever again for the reroll
                playSound(pullSound);

                // Respins
                reels.forEach(r => {
                    r.element.classList.add('spinning');
                    r.element.classList.remove('ignored');
                });

                await sleep(600);
            }

            // Phase 2: land FINAL results
            for (let i = 0; i < reels.length; i++) {
                const reel = reels[i];
                const finalValue = event.dice_rolls[i];

                reel.element.classList.remove('spinning');
                reel.strip.style.transform = `translateY(${-(finalValue - 1) * 200}px)`;

                reelsContainer.classList.add('shake');
                await sleep(100);
                reelsContainer.classList.remove('shake');
                await sleep(150);
            }

            reelsContainer.classList.remove('shake');

            // Highlight results
            await sleep(300);
            event.dice_rolls.forEach((value, idx) => {
                if (value === 6) {
                    reels[idx].element.classList.add('winner');
                } else if (value >= 4) {
                    reels[idx].element.style.borderColor = '#00ff88';
                }
            });

            // Result banner
            await sleep(300);
            const resultBanner = document.getElementById('result');
            let resultText = event.outcome;

            if (event.jackpot_count > 1) {
                resultText += ` x${event.jackpot_count}`;
            } else if (event.hit_count > 1 && event.jackpot_count === 0) {
                resultText += ` x${event.hit_count}`;
            }

            resultBanner.textContent = resultText;
            resultBanner.className = 'result-banner ' + event.outcome;

            // Sounds + effects
            if (event.outcome === 'JACKPOT') {
                for (let i = 0; i < event.jackpot_count; i++) {
                    setTimeout(() => {
                        const s = jackpotSound.cloneNode();
                        s.volume = Math.min(1, 0.6 + i * 0.15);
                        s.play().catch(() => {});
                    }, i * 400);
                }
                createParticles();
            } else if (event.outcome === 'HIT') {
                for (let i = 0; i < event.hit_count; i++) {
                    setTimeout(() => {
                        const s = hitSound.cloneNode();
                        s.volume = Math.min(1, 0.6 + i * 0.15);
                        s.play().catch(() => {});
                    }, i * 300);
                }
            } else {
                playSound(missSound);
            }

            // Payout
            await sleep(500);
            showPayout(event);
            updateUI();
        }

        function showPayout(event) {
            const payout = document.getElementById('payout');
            
            // Robots
            for (let i = 0; i < Math.min(event.robots_created, 20); i++) {
                setTimeout(() => {
                    const robot = document.createElement('div');
                    robot.className = 'payout-item';
                    robot.textContent = 'ðŸ¤–';
                    robot.style.animationDelay = `${i * 0.05}s`;
                    payout.appendChild(robot);
                }, i * 50);
            }
            
            // Treasures
            for (let i = 0; i < Math.min(event.treasures_created, 20); i++) {
                setTimeout(() => {
                    const treasure = document.createElement('div');
                    treasure.className = 'payout-item';
                    treasure.textContent = 'ðŸ’Ž';
                    treasure.style.animationDelay = `${i * 0.05}s`;
                    payout.appendChild(treasure);
                }, i * 50);
            }
            
            // Lifegain float
            if (event.life_gained > 0) {
                setTimeout(() => {
                    const lifeFloat = document.createElement('div');
                    lifeFloat.className = 'lifegain-float';
                    lifeFloat.textContent = `+${formatNumber(event.life_gained)}`;
                    lifeFloat.style.left = '50%';
                    lifeFloat.style.top = '50%';
                    payout.appendChild(lifeFloat);
                    
                    // Animate life counter
                    animateLifeCounter(state.life - event.life_gained, state.life);
                }, 200);
            }
        }

        function animateLifeCounter(start, end) {
            const duration = Math.min(2000, 500 + Math.log10(Math.abs(end - start) + 1) * 500);
            const startTime = Date.now();
            
            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (end - start) * eased);
                
                document.getElementById('life').textContent = formatNumber(current);
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            update();
        }

        function createParticles() {
            const container = document.getElementById('particles');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                const angle = (Math.PI * 2 * i) / 50;
                const distance = 200 + Math.random() * 300;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                container.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function toggleBarbarian() {
            playSound(nextSound);
            state.barbarian_class_active = !state.barbarian_class_active;
            updateUI();
        }

        function undo() {
            playSound(nextSound);
            if (!state.event_log.length) {
                alert('Nothing to undo');
                return;
            }
            
            const lastEvent = state.event_log.pop();
            
            // Revert state changes
            state.robots -= lastEvent.robots_created;
            state.treasures -= lastEvent.treasures_created;
            state.treasures += lastEvent.treasures_spent;
            state.life -= lastEvent.life_gained;
            state.jackpot_count -= lastEvent.jackpot_count;
            
            updateUI();
            document.getElementById('reels').innerHTML = '';
            document.getElementById('result').textContent = '';
            document.getElementById('payout').innerHTML = '';
        }

        function save() {
            playSound(nextSound);
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                alert('Game saved!');
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        function load() {
            playSound(nextSound);
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) {
                    alert('No save file found');
                    return;
                }
                state = JSON.parse(saved);
                updateUI();
                alert('Game loaded!');
            } catch (e) {
                alert('Failed to load: ' + e.message);
            }
        }

        function reset() {
            if (confirm('Reset all state?')) {
                playSound(nextSound);
                state = { ...defaultState, event_log: [] };
                updateUI();
                document.getElementById('reels').innerHTML = '';
                document.getElementById('result').textContent = '';
                document.getElementById('payout').innerHTML = '';
            }
        }

        // Hold-to-increment logic
        let holdTimeout = null;
        let holdInterval = null;
        let holdSpeed = 200;
        let holdStep = 1;

        function applyDelta(field, delta) {
            playSound(nextSound);

            let value = state[field] + delta;

            const minimums = {
                life: 0,
                robots: 0,
                treasures: 0,
                token_multiplier: 0,
                lifegain_multiplier: 0,
                etb_lifegain_sources: 0
            };

            value = Math.max(minimums[field], value);
            state[field] = value;
            updateUI();
        }

        function startHold(field, delta) {
            holdSpeed = 200;
            holdStep = 1;

            applyDelta(field, delta);

            holdTimeout = setTimeout(() => {
                holdInterval = setInterval(() => {
                    applyDelta(field, delta * holdStep);

                    holdSpeed = Math.max(holdSpeed * 0.8, 40);

                    if (holdSpeed < 120) holdStep = 5;
                    if (holdSpeed < 70) holdStep = 10;

                    clearInterval(holdInterval);
                    holdInterval = setInterval(() => {
                        applyDelta(field, delta * holdStep);
                    }, holdSpeed);

                }, holdSpeed);
            }, 250);
        }

        function stopHold() {
            clearTimeout(holdTimeout);
            clearInterval(holdInterval);
        }

        // Attach hold listeners
        document.querySelectorAll('.counter-btn').forEach(btn => {
            const field = btn.dataset.field;
            const delta = parseInt(btn.dataset.delta, 10);

            btn.addEventListener('mousedown', () => startHold(field, delta));
            btn.addEventListener('mouseup', stopHold);
            btn.addEventListener('mouseleave', stopHold);

            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startHold(field, delta);
            });
            btn.addEventListener('touchend', stopHold);
        });

        function updateLog() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            
            const reversed = [...state.event_log].reverse();
            reversed.slice(0, 20).forEach(event => {
                const entry = document.createElement('div');
                entry.className = 'log-entry ' + event.outcome;
                
                let outcomeDetail = event.outcome;
                if (event.jackpot_count > 0) {
                    outcomeDetail += ` (${event.jackpot_count}x6)`;
                }
                if (event.hit_count > 0) {
                    outcomeDetail += ` (${event.hit_count}x4-5)`;
                }
                if (event.miss_count > 0) {
                    outcomeDetail += ` (${event.miss_count}x1-3)`;
                }
                
                entry.innerHTML = `
                    <strong>${outcomeDetail}</strong> | 
                    Spent: ${event.treasures_spent}ðŸ’Ž | 
                    Rolled: [${event.dice_rolls.join(', ')}]${event.ignored_rolls.length > 0 ? ' Ignored: [' + event.ignored_rolls.join(', ') + ']' : ''} | 
                    +${event.robots_created}ðŸ¤– +${event.treasures_created}ðŸ’Ž +${event.life_gained}â¤ï¸
                `;
                log.appendChild(entry);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize
        updateUI();
    </script>
</body>
</html>
